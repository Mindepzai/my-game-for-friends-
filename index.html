<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trò chơi Touhou: Né đạn</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <!-- Thư viện Tone.js cho âm nhạc -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #1a1a2e; /* Nền tối */
            color: #e0e0e0; /* Chữ sáng */
            margin: 0;
            overflow: hidden; /* Ngăn cuộn */
            padding: 20px;
            box-sizing: border-box;
        }

        .game-container {
            background-color: #2a2a4a; /* Nền container trò chơi */
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            max-width: 90%; /* Giới hạn chiều rộng trên màn hình lớn */
            width: 500px; /* Chiều rộng cố định cho desktop */
            position: relative; /* Để overlay tạm dừng hoạt động */
            overflow: hidden; /* Đảm bảo nền sao không tràn ra ngoài */
        }

        canvas {
            background-color: #0d0d1a; /* Nền của canvas */
            border: 3px solid #6a0572; /* Viền màu tím */
            border-radius: 10px;
            display: block;
            touch-action: none; /* Ngăn cuộn/zoom trên thiết bị cảm ứng */
            width: 100%; /* Chiều rộng linh hoạt */
            max-width: 480px; /* Chiều rộng tối đa của canvas */
            height: 640px; /* Chiều cao cố định */
            position: relative;
            z-index: 1; /* Đảm bảo canvas ở trên nền sao */
        }

        .star-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            overflow: hidden;
            border-radius: 15px; /* Giống border-radius của game-container */
            z-index: 0; /* Đảm bảo nền sao ở dưới canvas */
        }

        .star {
            position: absolute;
            background-color: #fff;
            border-radius: 50%;
            opacity: 0;
            animation: twinkle 5s infinite ease-in-out;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0; }
            50% { opacity: 0.8; }
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 480px;
            font-size: 1.2em;
            font-weight: bold;
            color: #a0a0ff; /* Màu xanh nhạt */
            padding: 5px 0;
            border-bottom: 1px solid #4a4a6a;
            z-index: 2; /* Đảm bảo thông tin game ở trên */
        }

        .game-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            width: 100%;
            max-width: 480px;
            margin-top: 10px;
            flex-wrap: wrap; /* Cho phép xuống dòng trên màn hình nhỏ */
            z-index: 2; /* Đảm bảo nút điều khiển ở trên */
        }

        .game-over-screen, .paused-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); /* Nền tối hơn cho overlay */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 2em;
            text-align: center;
            z-index: 100;
            border-radius: 15px;
            gap: 20px;
            backdrop-filter: blur(5px); /* Hiệu ứng mờ nền */
        }

        .game-over-screen h2, .paused-overlay h2 {
            margin-bottom: 10px;
            color: #ff6b6b; /* Màu đỏ */
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.7);
        }

        .game-over-screen p {
            font-size: 0.8em;
            margin-bottom: 20px;
        }

        .button {
            background: linear-gradient(145deg, #8a2be2, #6a0572); /* Gradient tím */
            color: white;
            border: 2px solid #a052ee; /* Viền sáng hơn */
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            flex: 1; /* Cho phép các nút co giãn */
            min-width: 120px; /* Giới hạn chiều rộng tối thiểu */
        }

        .button:hover {
            background: linear-gradient(145deg, #6a0572, #8a2be2);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .button:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(0, 0, 0, 0.1);
        }

        /* Nút điều khiển trên di động */
        .mobile-controls {
            display: none; /* Mặc định ẩn */
            width: 100%;
            max-width: 480px;
            margin-top: 20px;
            justify-content: space-around;
            flex-wrap: wrap; /* Cho phép xuống dòng */
            gap: 10px; /* Khoảng cách giữa các nút */
        }

        .mobile-controls .control-button {
            background-color: #4a4a6a;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            touch-action: manipulation; /* Ngăn hành vi mặc định của trình duyệt */
            transition: background-color 0.2s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            width: 60px;
            height: 60px;
            flex-shrink: 0; /* Ngăn co lại */
        }

        .mobile-controls .control-button.focus-button {
            border-radius: 8px; /* Nút focus hình chữ nhật */
            width: auto;
            height: auto;
            padding: 12px 20px;
            font-size: 1em;
            background: linear-gradient(145deg, #28a745, #218838); /* Màu xanh lá */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .mobile-controls .control-button:active {
            background-color: #6a6a8a;
        }

        /* Thêm một container cho các nút điều khiển chính để cố định vị trí */
        .main-controls-container {
            position: fixed; /* Cố định vị trí */
            bottom: 20px; /* Cách đáy 20px */
            left: 50%;
            transform: translateX(-50%); /* Căn giữa */
            display: flex;
            gap: 10px;
            z-index: 200; /* Đảm bảo ở trên cùng */
            width: 100%;
            max-width: 500px; /* Giới hạn chiều rộng tương tự game-container */
            padding: 0 20px; /* Padding để không bị sát mép */
            box-sizing: border-box;
            justify-content: center; /* Căn giữa các nút */
        }

        /* Điều chỉnh nút chơi lại trong màn hình game over */
        #gameOverScreen .button {
            min-width: 180px; /* Đảm bảo nút chơi lại đủ rộng */
        }


        @media (max-width: 768px) {
            .game-container {
                padding: 15px;
                width: 95%;
            }
            canvas {
                height: 500px; /* Điều chỉnh chiều cao cho di động */
            }
            .game-info {
                font-size: 1em;
            }
            .game-over-screen, .paused-overlay {
                font-size: 1.5em;
            }
            .game-over-screen p {
                font-size: 0.7em;
            }
            .button {
                padding: 10px 15px;
                font-size: 0.9em;
                min-width: unset; /* Bỏ giới hạn min-width */
            }
            .mobile-controls {
                display: flex; /* Hiển thị trên di động */
            }
            .mobile-controls .control-button {
                width: 50px;
                height: 50px;
                font-size: 1.2em;
                padding: 10px;
            }
            .mobile-controls .control-button.focus-button {
                width: auto;
                height: auto;
                padding: 10px 15px;
                font-size: 0.9em;
            }
            .main-controls-container {
                position: static; /* Trở lại vị trí tĩnh trên di động nhỏ */
                margin-top: 20px; /* Khoảng cách với canvas */
                transform: none; /* Bỏ transform */
            }
        }

        @media (max-width: 480px) {
            .game-container {
                padding: 10px;
            }
            canvas {
                height: 400px; /* Điều chỉnh chiều cao cho di động nhỏ hơn */
            }
            .mobile-controls .control-button {
                width: 45px;
                height: 45px;
                font-size: 1em;
                padding: 8px;
            }
            .mobile-controls .control-button.focus-button {
                padding: 8px 12px;
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="star-background" id="starBackground"></div>
        <h1>Trò chơi Touhou: Né đạn</h1>
        <div class="game-info">
            <span id="scoreDisplay">Điểm: 0</span>
            <span id="difficultyDisplay">Độ khó: 1</span>
            <span id="revivesDisplay">Hồi sinh: 3</span> <!-- Cập nhật hiển thị hồi sinh -->
        </div>
        <canvas id="gameCanvas"></canvas>

        <!-- Các nút điều khiển chính được đặt trong một container riêng biệt, cố định vị trí -->
        <div class="main-controls-container">
            <button id="pauseButton" class="button">Tạm dừng</button>
            <button id="musicToggleButton" class="button">Tắt nhạc</button>
        </div>

        <div class="mobile-controls">
            <button class="control-button" id="upButton" aria-label="Lên">⬆️</button>
            <button class="control-button" id="leftButton" aria-label="Trái">⬅️</button>
            <button class="control-button" id="rightButton" aria-label="Phải">➡️</button>
            <button class="control-button" id="downButton" aria-label="Xuống">⬇️</button>
            <button class="control-button focus-button" id="focusButton" aria-label="Tập trung">Tập trung</button>
        </div>

        <div id="gameOverScreen" class="game-over-screen" style="display: none;">
            <h2>TRÒ CHƠI KẾT THÚC!</h2>
            <p>Thời gian sống sót của bạn: <span id="finalScore">0</span> giây</p>
            <button id="restartButton" class="button">Chơi lại</button>
        </div>

        <div id="pausedOverlay" class="paused-overlay" style="display: none;">
            <h2>TẠM DỪNG</h2>
            <p>Nhấn ESC hoặc nút "Tiếp tục" để tiếp tục</p>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const difficultyDisplay = document.getElementById('difficultyDisplay');
        const revivesDisplay = document.getElementById('revivesDisplay');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalScoreDisplay = document.getElementById('finalScore');
        const restartButton = document.getElementById('restartButton');
        const pauseButton = document.getElementById('pauseButton');
        const musicToggleButton = document.getElementById('musicToggleButton');
        const pausedOverlay = document.getElementById('pausedOverlay');
        const starBackground = document.getElementById('starBackground');

        // Nút điều khiển di động
        const upButton = document.getElementById('upButton');
        const leftButton = document.getElementById('leftButton');
        const rightButton = document.getElementById('rightButton');
        const downButton = document.getElementById('downButton');
        const focusButton = document.getElementById('focusButton');

        // Kích thước canvas (sẽ được cập nhật)
        let CANVAS_WIDTH = 480;
        let CANVAS_HEIGHT = 640;

        // Cập nhật kích thước canvas dựa trên CSS
        function updateCanvasSize() {
            const rect = canvas.getBoundingClientRect();
            CANVAS_WIDTH = rect.width;
            CANVAS_HEIGHT = rect.height;
            canvas.width = CANVAS_WIDTH;
            canvas.height = CANVAS_HEIGHT;
        }

        // Tạo nền sao động
        function createStars() {
            starBackground.innerHTML = ''; // Xóa sao cũ
            const numStars = 100;
            for (let i = 0; i < numStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.width = `${Math.random() * 3 + 1}px`;
                star.style.height = star.style.width;
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.animationDelay = `${Math.random() * 5}s`;
                starBackground.appendChild(star);
            }
        }

        // Gọi khi tải trang và khi thay đổi kích thước cửa sổ
        window.addEventListener('load', () => {
            updateCanvasSize();
            createStars();
        });
        window.addEventListener('resize', updateCanvasSize);

        // --- Biến trò chơi ---
        let gameRunning = false;
        let gamePaused = false;
        let score = 0;
        let startTime = 0;
        let lastFrameTime = 0;
        let difficultyLevel = 1;
        let difficultyTimer = 0;
        let revivesLeft = 3; // Số lần hồi sinh còn lại (Đã tăng lên 3)
        let isInvincible = false; // Trạng thái bất tử
        let invincibleTimer = 0;
        const INVINCIBLE_DURATION = 2; // Thời gian bất tử sau khi hồi sinh (giây)

        let deathCount = 0; // Số lần chết liên tiếp
        let scoreAtLastDeath = 0; // Điểm số khi chết lần gần nhất

        const ASSIST_DEATH_THRESHOLD = 3; // Số lần chết liên tiếp để kích hoạt hỗ trợ
        const ASSIST_SCORE_THRESHOLD = 10; // Nếu điểm số tăng ít hơn ngưỡng này sau các lần chết

        const ARTIFACT_SPAWN_INTERVAL = 50; // Mỗi 50 điểm sẽ xuất hiện cổ vật
        let nextArtifactScore = ARTIFACT_SPAWN_INTERVAL;
        const artifacts = []; // Mảng chứa các cổ vật


        // --- Đối tượng người chơi ---
        const player = {
            x: CANVAS_WIDTH / 2,
            y: CANVAS_HEIGHT - 50,
            radius: 8,
            speed: 10,
            focusSpeedMultiplier: 0.4,
            color: '#00ffff',
            hitboxRadius: 2,
            isFocusing: false
        };

        // --- Mảng đạn và kẻ địch ---
        const bullets = [];
        const enemies = [];

        // --- Đầu vào bàn phím ---
        const keys = {
            ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false,
            KeyW: false, KeyA: false, KeyS: false, KeyD: false,
            ShiftLeft: false, ShiftRight: false
        };

        // --- Xử lý sự kiện bàn phím ---
        window.addEventListener('keydown', (e) => {
            if (keys.hasOwnProperty(e.code)) { keys[e.code] = true; }
            else if (keys.hasOwnProperty(e.key)) { keys[e.key] = true; }
            if (e.key === 'Escape' || e.code === 'Escape') { togglePause(); }
        });

        window.addEventListener('keyup', (e) => {
            if (keys.hasOwnProperty(e.code)) { keys[e.code] = false; }
            else if (keys.hasOwnProperty(e.key)) { keys[e.key] = false; }
        });

        // --- Xử lý sự kiện chạm cho điều khiển di động ---
        function setupMobileControls() {
            const touchStart = (key) => (e) => { e.preventDefault(); keys[key] = true; };
            const touchEnd = (key) => (e) => { e.preventDefault(); keys[key] = false; };

            upButton.addEventListener('touchstart', touchStart('ArrowUp'));
            upButton.addEventListener('touchend', touchEnd('ArrowUp'));
            upButton.addEventListener('touchcancel', touchEnd('ArrowUp'));

            downButton.addEventListener('touchstart', touchStart('ArrowDown'));
            downButton.addEventListener('touchend', touchEnd('ArrowDown'));
            downButton.addEventListener('touchcancel', touchEnd('ArrowDown'));

            leftButton.addEventListener('touchstart', touchStart('ArrowLeft'));
            leftButton.addEventListener('touchend', touchEnd('ArrowLeft'));
            leftButton.addEventListener('touchcancel', touchEnd('ArrowLeft'));

            rightButton.addEventListener('touchstart', touchStart('ArrowRight'));
            rightButton.addEventListener('touchend', touchEnd('ArrowRight'));
            rightButton.addEventListener('touchcancel', touchEnd('ArrowRight'));

            focusButton.addEventListener('touchstart', (e) => { e.preventDefault(); player.isFocusing = true; });
            focusButton.addEventListener('touchend', (e) => { e.preventDefault(); player.isFocusing = false; });
            focusButton.addEventListener('touchcancel', (e) => { e.preventDefault(); player.isFocusing = false; });
        }

        window.addEventListener('load', setupMobileControls);


        // --- Hàm vẽ ---
        function drawPlayer() {
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
            ctx.fillStyle = player.color;
            ctx.fill();
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 1;
            ctx.stroke();

            // Vẽ hitbox nhỏ và làm nó nhấp nháy khi ở chế độ tập trung hoặc bất tử
            if (player.isFocusing || isInvincible || (difficultyLevel >= 5 && score % 2 === 0)) {
                ctx.beginPath();
                ctx.arc(player.x, player.y, player.hitboxRadius, 0, Math.PI * 2);
                ctx.fillStyle = isInvincible ? 'rgba(0, 255, 255, 0.5)' : 'rgba(255, 0, 0, 0.7)'; // Màu xanh khi bất tử
                ctx.fill();
                ctx.strokeStyle = isInvincible ? 'rgba(255, 255, 255, 0.9)' : 'rgba(255, 255, 255, 0.9)';
                ctx.lineWidth = 1.5;
                ctx.stroke();
            }
        }

        // Hiệu ứng vệt sáng cho đạn
        const bulletTrails = [];
        function drawBullet(bullet) {
            // Thêm vị trí hiện tại của đạn vào vệt sáng
            bulletTrails.push({ x: bullet.x, y: bullet.y, radius: bullet.radius, color: bullet.color, alpha: 1 });

            // Vẽ các điểm trong vệt sáng
            for (let i = bulletTrails.length - 1; i >= 0; i--) {
                const trail = bulletTrails[i];
                if (trail.radius < 0.1) { // Xóa nếu quá nhỏ
                    bulletTrails.splice(i, 1);
                    continue;
                }
                ctx.beginPath();
                ctx.arc(trail.x, trail.y, trail.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(${parseInt(trail.color.slice(1, 3), 16)}, ${parseInt(trail.color.slice(3, 5), 16)}, ${parseInt(trail.color.slice(5, 7), 16)}, ${trail.alpha * 0.5})`;
                ctx.fill();
                trail.radius *= 0.9; // Giảm kích thước
                trail.alpha *= 0.9; // Giảm độ trong suốt
            }

            // Vẽ viên đạn chính
            ctx.beginPath();
            ctx.arc(bullet.x, bullet.y, bullet.radius, 0, Math.PI * 2);
            ctx.fillStyle = bullet.color;
            ctx.fill();
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.lineWidth = 1;
            ctx.stroke();
        }

        function drawEnemy(enemy) {
            ctx.fillStyle = enemy.color;
            ctx.fillRect(enemy.x - enemy.width / 2, enemy.y - enemy.height / 2, enemy.width, enemy.height);
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.strokeRect(enemy.x - enemy.width / 2, enemy.y - enemy.height / 2, enemy.width, enemy.height);
        }

        // --- Cổ vật ---
        function createArtifact() {
            const type = Math.floor(Math.random() * 3); // 0: Slow, 1: Speed, 2: Clear
            const x = Math.random() * (CANVAS_WIDTH - 40) + 20;
            const y = Math.random() * (CANVAS_HEIGHT / 2 - 40) + 20; // Chỉ xuất hiện ở nửa trên màn hình
            artifacts.push({
                x: x,
                y: y,
                radius: 15,
                color: type === 0 ? 'yellow' : (type === 1 ? 'lime' : 'orange'),
                type: type,
                life: 5 // Tồn tại 5 giây
            });
        }

        function drawArtifact(artifact) {
            ctx.beginPath();
            ctx.arc(artifact.x, artifact.y, artifact.radius, 0, Math.PI * 2);
            ctx.fillStyle = artifact.color;
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.fillStyle = 'black';
            ctx.font = '12px Inter';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            let text = '';
            if (artifact.type === 0) text = 'S'; // Slow
            else if (artifact.type === 1) text = 'F'; // Fast
            else text = 'C'; // Clear
            ctx.fillText(text, artifact.x, artifact.y);
        }

        function updateArtifacts(deltaTime) {
            for (let i = artifacts.length - 1; i >= 0; i--) {
                const artifact = artifacts[i];
                artifact.life -= deltaTime;
                if (artifact.life <= 0) {
                    artifacts.splice(i, 1);
                }
            }
        }

        // --- Hàm cập nhật ---
        function updatePlayer(deltaTime) {
            player.isFocusing = keys.ShiftLeft || keys.ShiftRight;

            const currentSpeed = player.isFocusing ? player.speed * player.focusSpeedMultiplier : player.speed;

            if (keys.ArrowUp || keys.KeyW) player.y -= currentSpeed;
            if (keys.ArrowDown || keys.KeyS) player.y += currentSpeed;
            if (keys.ArrowLeft || keys.KeyA) player.x -= currentSpeed;
            if (keys.ArrowRight || keys.KeyD) player.x += currentSpeed;

            player.x = Math.max(player.radius, Math.min(CANVAS_WIDTH - player.radius, player.x));
            player.y = Math.max(player.radius, Math.min(CANVAS_HEIGHT - player.radius, player.y));

            // Cập nhật trạng thái bất tử
            if (isInvincible) {
                invincibleTimer -= deltaTime;
                if (invincibleTimer <= 0) {
                    isInvincible = false;
                    player.color = '#00ffff'; // Trở lại màu ban đầu
                } else {
                    // Hiệu ứng nhấp nháy khi bất tử
                    player.color = (Math.floor(invincibleTimer * 10) % 2 === 0) ? '#00ffff' : '#ff00ff';
                }
            }
        }

        function updateBullets() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.x += bullet.vx;
                bullet.y += bullet.vy;

                if (bullet.x < -bullet.radius || bullet.x > CANVAS_WIDTH + bullet.radius ||
                    bullet.y < -bullet.radius || bullet.y > CANVAS_HEIGHT + bullet.radius) {
                    bullets.splice(i, 1);
                }
            }
        }

        function createBullet(x, y, angle, speed, radius, color) {
            bullets.push({
                x: x,
                y: y,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                radius: radius,
                color: color
            });
        }

        function createEnemy(x, y, width, height, color, shootInterval) {
            enemies.push({
                x: x,
                y: y,
                width: width,
                height: height,
                color: color,
                shootInterval: shootInterval,
                lastShotTime: 0
            });
        }

        // --- Hàm bắn đạn của kẻ địch (phức tạp hơn) ---
        function enemyShoot(enemy, deltaTime) {
            enemy.lastShotTime += deltaTime;

            let bulletSpeed = 4 + difficultyLevel * 0.7; // Giảm tốc độ đạn tăng theo độ khó một chút nữa
            let bulletRadius = 6 + difficultyLevel * 0.3; // Giảm kích thước đạn tăng theo độ khó một chút nữa
            let bulletColor = `hsl(${Math.random() * 360}, 100%, 70%)`;

            if (enemy.lastShotTime >= enemy.shootInterval) {
                enemy.lastShotTime = 0;

                // KHÔNG xóa tất cả đạn cũ khi một mẫu mới bắt đầu để duy trì tính liên tục
                // bullets.length = 0;
                // bulletTrails.length = 0;

                const pattern = difficultyLevel % 13; // 13 mẫu đạn khác nhau (0-12)

                switch (pattern) {
                    case 0: // Đạn thẳng đơn giản
                        createBullet(enemy.x, enemy.y + enemy.height / 2, Math.PI / 2, bulletSpeed, bulletRadius, bulletColor);
                        break;
                    case 1: // Đạn tỏa tròn (giảm số lượng)
                        const numBulletsSpread = 8 + difficultyLevel * 1.2;
                        for (let i = 0; i < numBulletsSpread; i++) {
                            const angle = Math.PI / 2 - (numBulletsSpread / 2 - i) * (Math.PI / 9); // Góc rộng hơn
                            createBullet(enemy.x, enemy.y + enemy.height / 2, angle, bulletSpeed, bulletRadius, bulletColor);
                        }
                        break;
                    case 2: // Đạn xoắn ốc (giảm số lượng)
                        const spiralSpeed = bulletSpeed * 0.9;
                        const spiralRadius = bulletRadius * 1.0;
                        const numSpiralBullets = 10 + difficultyLevel * 2;
                        for (let i = 0; i < numSpiralBullets; i++) {
                            const angle = (i * (Math.PI * 2 / numSpiralBullets)) + (Date.now() * 0.001 * (difficultyLevel * 0.1));
                            createBullet(enemy.x, enemy.y + enemy.height / 2, angle, spiralSpeed, spiralRadius, bulletColor);
                        }
                        break;
                    case 3: // Đạn nhắm thẳng vào người chơi
                        const angleToPlayer = Math.atan2(player.y - enemy.y, player.x - enemy.x);
                        createBullet(enemy.x, enemy.y + enemy.height / 2, angleToPlayer, bulletSpeed * 1.3, bulletRadius, bulletColor);
                        break;
                    case 4: // Đạn sóng (giảm biên độ và tần số)
                        const waveSpeed = bulletSpeed * 0.8;
                        const waveAmplitude = 12 + difficultyLevel * 2;
                        const waveFrequency = 0.07;
                        for (let i = 0; i < 5; i++) {
                            const offsetY = Math.sin((enemy.x + i * 40) * waveFrequency + Date.now() * 0.002) * waveAmplitude;
                            createBullet(enemy.x + i * 30 - 60, enemy.y + enemy.height / 2 + offsetY, Math.PI / 2, waveSpeed, bulletRadius, bulletColor);
                        }
                        break;
                    case 5: // Đạn nhắm thẳng với quạt (giảm số lượng)
                        const fanAngle = Math.PI / 5;
                        const baseAngleToPlayer = Math.atan2(player.y - enemy.y, player.x - enemy.x);
                        for (let i = -1; i <= 1; i++) { // 3 viên đạn
                            createBullet(enemy.x, enemy.y + enemy.height / 2, baseAngleToPlayer + i * fanAngle / 2, bulletSpeed * 1.1, bulletRadius, bulletColor);
                        }
                        break;
                    case 6: // Bức tường đạn với khe hở (giảm số lượng)
                        const wallBulletCount = 15;
                        const gapSize = bulletRadius * 4; // Kích thước khe hở lớn hơn
                        const gapPosition = Math.floor(Math.random() * (wallBulletCount - 2));
                        for (let i = 0; i < wallBulletCount; i++) {
                            if (i !== gapPosition && i !== gapPosition + 1) {
                                const bulletX = (CANVAS_WIDTH / wallBulletCount) * i + (CANVAS_WIDTH / wallBulletCount / 2);
                                createBullet(bulletX, enemy.y + enemy.height / 2, Math.PI / 2, bulletSpeed * 0.8, bulletRadius, bulletColor);
                            }
                        }
                        break;
                    case 7: // Đạn "hoa" (giảm số lượng từng lớp)
                        const innerBullets = 5 + difficultyLevel * 0.8;
                        const middleBullets = 10 + difficultyLevel * 1.2;
                        const outerBullets = 15 + difficultyLevel * 1.5;
                        for (let i = 0; i < innerBullets; i++) {
                            const angle = (i * (Math.PI * 2 / innerBullets));
                            createBullet(enemy.x, enemy.y + enemy.height / 2, angle, bulletSpeed * 0.6, bulletRadius * 0.7, bulletColor);
                        }
                        for (let i = 0; i < middleBullets; i++) {
                            const angle = (i * (Math.PI * 2 / middleBullets)) + (Math.PI / middleBullets / 2);
                            createBullet(enemy.x, enemy.y + enemy.height / 2, angle, bulletSpeed * 0.8, bulletRadius * 0.9, bulletColor);
                        }
                        for (let i = 0; i < outerBullets; i++) {
                            const angle = (i * (Math.PI * 2 / outerBullets)) + (Math.PI / outerBullets);
                            createBullet(enemy.x, enemy.y + enemy.height / 2, angle, bulletSpeed * 1.0, bulletRadius * 1.1, bulletColor);
                        }
                        break;
                    case 8: // Đạn ngẫu nhiên hỗn loạn (giảm số lượng và tốc độ)
                        const chaoticBulletCount = 10 + difficultyLevel * 2;
                        for (let i = 0; i < chaoticBulletCount; i++) {
                            const randomAngle = Math.random() * Math.PI * 2;
                            const randomSpeed = bulletSpeed * (0.4 + Math.random() * 0.3);
                            const randomRadius = bulletRadius * (0.6 + Math.random() * 0.2);
                            createBullet(enemy.x, enemy.y + enemy.height / 2, randomAngle, randomSpeed, randomRadius, bulletColor);
                        }
                        break;
                    case 9: // Cơn mưa đạn (Barrage giảm số lượng và tốc độ)
                        const barrageCount = 1 + difficultyLevel * 0.5;
                        const barrageSpread = Math.PI / 5;
                        const barrageSpeed = bulletSpeed * 1.0;
                        const barrageDelay = 0.08;

                        for (let i = 0; i < barrageCount; i++) {
                            const angleOffset = (Math.random() - 0.5) * barrageSpread;
                            const angle = Math.atan2(player.y - enemy.y, player.x - enemy.x) + angleOffset;
                            setTimeout(() => {
                                createBullet(enemy.x, enemy.y + enemy.height / 2, angle, barrageSpeed, bulletRadius * 0.7, 'red');
                            }, i * barrageDelay * 1000);
                        }
                        break;
                    case 10: // Đạn thẳng đứng (giảm số lượng)
                        const verticalBulletCount = 3 + difficultyLevel * 0.8;
                        const verticalBulletSpacing = CANVAS_WIDTH / (verticalBulletCount + 1);
                        for (let i = 0; i < verticalBulletCount; i++) {
                            const bulletX = (i + 1) * verticalBulletSpacing;
                            createBullet(bulletX, enemy.y + enemy.height / 2, Math.PI / 2, bulletSpeed * 0.5, bulletRadius, 'purple');
                        }
                        break;
                    case 11: // Mẫu mới: Đạn chéo xoay (tốc độ xoay giảm)
                        const crossBulletCount = 4;
                        const rotationSpeed = 0.0003 * difficultyLevel;
                        const baseAngle = Date.now() * rotationSpeed;
                        for (let i = 0; i < crossBulletCount; i++) {
                            const angle = baseAngle + (i * Math.PI / 2);
                            createBullet(enemy.x, enemy.y + enemy.height / 2, angle, bulletSpeed * 0.8, bulletRadius, 'orange');
                        }
                        break;
                    case 12: // Mẫu mới: Đạn theo đường zic-zac (biên độ và tần số giảm)
                        const zigzagBulletCount = 4 + difficultyLevel * 0.8;
                        const zigzagAmplitude = 15 + difficultyLevel * 2;
                        const zigzagFrequency = 0.04;
                        for (let i = 0; i < zigzagBulletCount; i++) {
                            const bulletXOffset = Math.sin(i * zigzagFrequency + Date.now() * 0.002) * zigzagAmplitude;
                            createBullet(enemy.x + bulletXOffset, enemy.y + enemy.height / 2, Math.PI / 2, bulletSpeed * 0.6, bulletRadius, 'cyan');
                        }
                        break;
                }
            }
        }

        // --- Phát hiện va chạm (hình tròn vs hình tròn) ---
        function checkCollision(circle1, circle2) {
            const dx = circle1.x - circle2.x;
            const dy = circle1.y - circle2.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            return distance < circle1.radius + circle2.radius;
        }

        // --- Âm nhạc nền (sử dụng Tone.js) ---
        let synth;
        let bassSynth;
        let drumSynth;
        let reverb;
        let delay;
        let masterGain;
        let melodyLoop;
        let bassLoop;
        let drumLoop;
        let isMusicPlaying = false;

        function initMusic() {
            if (!synth) {
                // Hiệu ứng Reverb và Delay
                reverb = new Tone.Reverb(2).toDestination();
                delay = new Tone.FeedbackDelay("8n", 0.5).toDestination();

                // Synth cho giai điệu chính
                synth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "triangle" },
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0.4, release: 0.8 }
                }).chain(reverb, delay, Tone.Destination);

                // Synth cho bassline
                bassSynth = new Tone.Synth({
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0.5, release: 1.2 }
                }).chain(reverb, Tone.Destination);

                // Synth cho trống (kick và snare đơn giản)
                drumSynth = new Tone.MembraneSynth({
                    pitchDecay: 0.05,
                    octaves: 10,
                    envelope: {
                        attack: 0.001,
                        decay: 0.4,
                        sustain: 0.01,
                        release: 1.4,
                        attackCurve: "exponential"
                    }
                }).toDestination();

                masterGain = new Tone.Gain(0.4).toDestination();
                synth.connect(masterGain);
                bassSynth.connect(masterGain);
                drumSynth.connect(masterGain);

                // Giai điệu chính
                const melodyNotes = [
                    "C4", "E4", "G4", "A4",
                    "G4", "E4", "C4", "F4",
                    "E4", "G4", "C5", "A4",
                    "G4", "E4", "D4", "C4"
                ];
                let melodyIndex = 0;
                melodyLoop = new Tone.Loop((time) => {
                    synth.triggerAttackRelease(melodyNotes[melodyIndex % melodyNotes.length], "8n", time);
                    melodyIndex++;
                }, "4n").start(0);

                // Bassline
                const bassNotes = ["C2", "C2", "F2", "F2", "G2", "G2", "C2", "C2"];
                let bassIndex = 0;
                bassLoop = new Tone.Loop((time) => {
                    bassSynth.triggerAttackRelease(bassNotes[bassIndex % bassNotes.length], "2n", time);
                    bassIndex++;
                }, "2n").start(0);

                // Drum beat đơn giản
                const drumPattern = [
                    ["C1"], [], ["C1"], [],
                    ["C1"], [], ["C1"], [],
                    ["C1"], [], ["C1"], [],
                    ["C1"], [], ["C1"], []
                ]; // Kick drum on quarter notes
                let drumIndex = 0;
                drumLoop = new Tone.Sequence((time, note) => {
                    drumSynth.triggerAttackRelease(note, "16n", time);
                }, drumPattern, "8n").start(0); // Mỗi 1/8 nốt

                Tone.Transport.bpm.value = 140;
            }
        }

        async function toggleMusic() {
            await Tone.start();
            initMusic();

            if (isMusicPlaying) {
                Tone.Transport.stop();
                musicToggleButton.textContent = 'Bật nhạc';
                masterGain.gain.linearRampToValueAtTime(0, Tone.context.currentTime + 0.5);
            } else {
                Tone.Transport.start();
                musicToggleButton.textContent = 'Tắt nhạc';
                masterGain.gain.linearRampToValueAtTime(0.4, Tone.context.currentTime + 0.5);
            }
            isMusicPlaying = !isMusicPlaying;
        }

        // --- Hiệu ứng âm thanh (SFX) ---
        let hitSynth;
        let difficultyUpSynth;
        let artifactCollectSynth; // SFX cho cổ vật

        function initSFX() {
            // Chỉ khởi tạo một lần
            if (!hitSynth) {
                hitSynth = new Tone.NoiseSynth({
                    envelope: {
                        attack: 0.001,
                        decay: 0.1,
                        sustain: 0,
                        release: 0.1
                    },
                    noise: { type: 'white' }
                }).toDestination();
                hitSynth.volume.value = -10; // Giảm âm lượng
            }
            if (!difficultyUpSynth) {
                difficultyUpSynth = new Tone.Synth({
                    oscillator: { type: 'square' },
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0.0, release: 0.2 }
                }).toDestination();
                difficultyUpSynth.volume.value = -10; // Giảm âm lượng
            }
            if (!artifactCollectSynth) {
                artifactCollectSynth = new Tone.Synth({
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.005, decay: 0.05, sustain: 0.0, release: 0.1 }
                }).toDestination();
                artifactCollectSynth.volume.value = -8; // Tăng âm lượng SFX cổ vật
            }
        }

        async function playHitSFX() {
            await Tone.start();
            hitSynth.triggerAttackRelease("C3", "8n");
        }

        async function playDifficultyUpSFX() {
            await Tone.start();
            difficultyUpSynth.triggerAttackRelease("C5", "16n", Tone.now());
            difficultyUpSynth.triggerAttackRelease("G5", "16n", Tone.now() + 0.1);
        }

        async function playArtifactCollectSFX() {
            await Tone.start();
            artifactCollectSynth.triggerAttackRelease("E6", "16n");
            artifactCollectSynth.triggerAttackRelease("G6", "16n", Tone.now() + 0.05);
        }

        // --- Hàm kích hoạt hỗ trợ (Assist) ---
        function triggerAssist() {
            bullets.length = 0; // Xóa tất cả đạn
            bulletTrails.length = 0; // Xóa vệt sáng đạn
            isInvincible = true;
            invincibleTimer = INVINCIBLE_DURATION * 1.5; // Tăng thời gian bất tử khi hỗ trợ
            player.x = CANVAS_WIDTH / 2;
            player.y = CANVAS_HEIGHT - 50; // Đưa người chơi về vị trí an toàn
            playDifficultyUpSFX(); // Phát âm thanh hỗ trợ
            console.log("Assist Mode Activated!");
        }

        // --- Hàm tạm dừng/tiếp tục trò chơi ---
        function togglePause() {
            if (!gameRunning) return;

            gamePaused = !gamePaused;
            if (gamePaused) {
                pauseButton.textContent = 'Tiếp tục';
                pausedOverlay.style.display = 'flex';
                if (isMusicPlaying) {
                    Tone.Transport.pause();
                    masterGain.gain.linearRampToValueAtTime(0, Tone.context.currentTime + 0.2);
                }
            } else {
                pauseButton.textContent = 'Tạm dừng';
                pausedOverlay.style.display = 'none';
                lastFrameTime = performance.now();
                if (isMusicPlaying) {
                    Tone.Transport.start();
                    masterGain.gain.linearRampToValueAtTime(0.4, Tone.context.currentTime + 0.2);
                }
                requestAnimationFrame(gameLoop);
            }
        }

        // --- Vòng lặp trò chơi chính ---
        function gameLoop(currentTime) {
            if (!gameRunning || gamePaused) return;

            const deltaTime = (currentTime - lastFrameTime) / 1000;
            lastFrameTime = currentTime;

            score = Math.floor((currentTime - startTime) / 1000);
            scoreDisplay.textContent = `Điểm: ${score}`;

            // Tạo cổ vật
            if (score >= nextArtifactScore) {
                createArtifact();
                nextArtifactScore += ARTIFACT_SPAWN_INTERVAL;
            }

            difficultyTimer += deltaTime;
            const difficultyIncreaseInterval = 4;
            if (difficultyTimer >= difficultyIncreaseInterval) {
                difficultyLevel++;
                difficultyTimer = 0;
                difficultyDisplay.textContent = `Độ khó: ${difficultyLevel}`;
                enemies.forEach(enemy => {
                    enemy.shootInterval = Math.max(0.04, enemy.shootInterval * 0.8);
                });
                playDifficultyUpSFX(); // Phát SFX khi tăng độ khó
            }

            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            updatePlayer(deltaTime);
            drawPlayer();

            updateBullets();
            bullets.forEach(drawBullet);

            updateArtifacts(deltaTime);
            artifacts.forEach(drawArtifact);

            enemies.forEach(enemy => {
                drawEnemy(enemy);
                enemyShoot(enemy, deltaTime);
            });

            // Kiểm tra va chạm người chơi với đạn
            if (!isInvincible) {
                for (let i = 0; i < bullets.length; i++) {
                    if (checkCollision({ x: player.x, y: player.y, radius: player.hitboxRadius }, bullets[i])) {
                        playHitSFX(); // Phát SFX khi bị bắn trúng

                        // Kiểm tra điều kiện hỗ trợ
                        deathCount++;
                        if (deathCount >= ASSIST_DEATH_THRESHOLD && (score - scoreAtLastDeath < ASSIST_SCORE_THRESHOLD)) {
                             triggerAssist();
                             deathCount = 0; // Đặt lại bộ đếm chết sau khi hỗ trợ
                             scoreAtLastDeath = score; // Cập nhật điểm số khi hỗ trợ
                        } else if (revivesLeft > 0) {
                            revivesLeft--;
                            revivesDisplay.textContent = `Hồi sinh: ${revivesLeft}`;
                            isInvincible = true;
                            invincibleTimer = INVINCIBLE_DURATION;
                            player.x = CANVAS_WIDTH / 2;
                            player.y = CANVAS_HEIGHT - 50;
                            bullets.length = 0;
                            bulletTrails.length = 0; // Xóa vệt sáng đạn
                            scoreAtLastDeath = score; // Cập nhật điểm số khi hồi sinh
                        } else {
                            gameOver();
                            return;
                        }
                        break; // Thoát vòng lặp để tránh va chạm nhiều lần
                    }
                }
            }

            // Kiểm tra va chạm người chơi với cổ vật
            for (let i = artifacts.length - 1; i >= 0; i--) {
                const artifact = artifacts[i];
                if (checkCollision(player, artifact)) {
                    playArtifactCollectSFX(); // Phát SFX khi nhặt cổ vật
                    // Kích hoạt hiệu ứng cổ vật
                    if (artifact.type === 0) { // Slow
                        bullets.forEach(b => b.speed *= 0.6); // Giảm tốc độ đạn hiện có
                        setTimeout(() => {
                            bullets.forEach(b => b.speed /= 0.6); // Trở lại tốc độ ban đầu
                        }, 3000); // Kéo dài 3 giây
                    } else if (artifact.type === 1) { // Speed
                        player.speed *= 1.5; // Tăng tốc độ người chơi
                        setTimeout(() => {
                            player.speed /= 1.5; // Trở lại tốc độ ban đầu
                        }, 3000); // Kéo dài 3 giây
                    } else if (artifact.type === 2) { // Clear
                        bullets.length = 0; // Xóa tất cả đạn trên màn hình
                        bulletTrails.length = 0;
                    }
                    artifacts.splice(i, 1); // Xóa cổ vật đã nhặt
                }
            }


            requestAnimationFrame(gameLoop);
        }

        // --- Hàm bắt đầu trò chơi ---
        async function startGame() {
            updateCanvasSize();
            createStars();
            gameRunning = true;
            gamePaused = false;
            score = 0;
            difficultyLevel = 1;
            difficultyTimer = 0;
            revivesLeft = 3; // Đặt lại số lần hồi sinh
            isInvincible = false;
            invincibleTimer = 0;
            deathCount = 0; // Đặt lại số lần chết
            scoreAtLastDeath = 0; // Đặt lại điểm số khi chết
            nextArtifactScore = ARTIFACT_SPAWN_INTERVAL; // Đặt lại mốc cổ vật
            startTime = performance.now();
            lastFrameTime = startTime;

            player.x = CANVAS_WIDTH / 2;
            player.y = CANVAS_HEIGHT - 50;
            player.color = '#00ffff';
            player.isFocusing = false;
            player.speed = 10; // Đảm bảo tốc độ người chơi được reset

            bullets.length = 0;
            enemies.length = 0;
            bulletTrails.length = 0;
            artifacts.length = 0; // Xóa tất cả cổ vật

            createEnemy(CANVAS_WIDTH / 2, 50, 60, 60, '#ff00ff', 0.8);

            gameOverScreen.style.display = 'none';
            pausedOverlay.style.display = 'none';
            scoreDisplay.textContent = `Điểm: 0`;
            difficultyDisplay.textContent = `Độ khó: 1`;
            revivesDisplay.textContent = `Hồi sinh: ${revivesLeft}`;
            pauseButton.textContent = 'Tạm dừng';

            initMusic();
            initSFX();
            if (!isMusicPlaying) {
                await toggleMusic();
            } else {
                if (Tone.Transport.state === 'paused' || Tone.Transport.state === 'stopped') {
                    Tone.Transport.start();
                }
                masterGain.gain.linearRampToValueAtTime(0.4, Tone.context.currentTime + 0.2);
            }

            requestAnimationFrame(gameLoop);
        }

        // --- Hàm kết thúc trò chơi ---
        function gameOver() {
            gameRunning = false;
            gamePaused = true;
            finalScoreDisplay.textContent = score;
            gameOverScreen.style.display = 'flex';
            if (isMusicPlaying) {
                Tone.Transport.stop();
                masterGain.gain.linearRampToValueAtTime(0, Tone.context.currentTime + 0.5);
            }
        }

        // --- Nút chơi lại ---
        restartButton.addEventListener('click', startGame);
        pauseButton.addEventListener('click', togglePause);
        musicToggleButton.addEventListener('click', toggleMusic);

        // Bắt đầu trò chơi khi tải trang
        window.onload = startGame;
    </script>
</body>
</html>
